<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุฅุถุงูุฉ ุฌุฏูู ุฏุฑุงุณู ุฌุฏูุฏ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="../js/auth.js"></script>
  <script src="../js/lessons.js"></script>
  <!-- Shared Header -->
  <script src="../shared/shared-header.js"></script>
  <style>
    body{background:linear-gradient(to bottom right,#eef2ff,#f0f9ff,#f5f3ff);min-height:100vh;}
    html.dark body{background:linear-gradient(to bottom right,#0f172a,#1e293b,#312e81);}    
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Shared Header Container -->
  <div id="shared-header-container">
    <!-- Header will be loaded by shared-header.js -->
  </div>

  <!-- Header ูุธูุฑ ููุท ูููุฏุฑุณ / ุงูุงุฏูู -->
  <header id="pageHeader" class="bg-white/90 backdrop-blur shadow-md sticky top-0 z-30 hidden">
    <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xl">
          <i class="fas fa-calendar-plus"></i>
        </div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold text-gray-800">ุฅุถุงูุฉ ุฌุฏูู ุฏุฑุงุณู ุฌุฏูุฏ</h1>
          <p class="text-gray-500 text-sm">ูุฐู ุงูุตูุญุฉ ูุชุงุญุฉ ูููุนูู ุฃู ุงูุฃุฏูู ููุท</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <a href="javascript:goBack()" class="px-4 py-2 rounded-lg border text-sm hover:bg-gray-50 flex items-center gap-2"><i class="fas fa-arrow-right"></i><span>ุฑุฌูุน</span></a>
        <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm flex items-center gap-2"><i class="fas fa-right-from-bracket"></i><span>ุฎุฑูุฌ</span></button>
      </div>
    </div>
  </header>

  <main class="flex-1 container mx-auto px-4 py-10">
    <div id="accessDenied" class="max-w-xl mx-auto hidden">
      <div class="bg-red-50 border border-red-200 text-red-700 p-6 rounded-xl shadow">
        <h2 class="text-xl font-bold mb-2">๐ซ ุบูุฑ ูุตุฑุญ</h2>
        <p class="mb-4 text-sm leading-relaxed">ูุฐู ุงูุตูุญุฉ ูุฎุตุตุฉ ูููุฏุฑุณูู ุฃู ุงููุณุคูููู ููุท. ุฅุฐุง ููุช ุชููู ุญุณุงุจุงู ุจุตูุงุญูุงุช ููุงุณุจุฉ ูู <a href="index_updated.html" class="underline">ุจุชุณุฌูู ุงูุฏุฎูู</a>.</p>
        <a href="index_updated.html" class="inline-block px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ</a>
      </div>
    </div>

    <div id="scheduleFormWrapper" class="max-w-2xl mx-auto hidden">
      <form id="scheduleForm" onsubmit="handleSubmit(event)" class="bg-white rounded-2xl shadow-xl p-8 space-y-6 relative overflow-hidden">
        <div class="absolute inset-0 pointer-events-none opacity-[0.07] bg-[radial-gradient(circle_at_30%_30%,#6366f1,transparent_60%)]"></div>
        <h2 class="text-2xl font-bold text-gray-800 relative z-10 flex items-center gap-2"><i class="fas fa-calendar-plus"></i><span>ุชูุงุตูู ุงูุฌุฏูู ุงูุฏุฑุงุณู</span></h2>
        <div class="grid md:grid-cols-2 gap-5 relative z-10">
          <div class="space-y-2 md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700">ุงูุตู ุงูุฏุฑุงุณู</label>
            <select name="grade" id="grade" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" required>
              <option value="" disabled selected>ุงุฎุชุฑ ุงูุตู</option>
              <option value="ุงูุตู ุงูุฃูู ุงูุซุงููู">ุงูุตู ุงูุฃูู ุงูุซุงููู</option>
              <option value="ุงูุตู ุงูุซุงูู ุงูุซุงููู ุนููู">ุงูุตู ุงูุซุงูู ุงูุซุงููู ุนููู</option>
              <option value="ุงูุตู ุงูุซุงูู ุงูุซุงููู ุงุฏุจู">ุงูุตู ุงูุซุงูู ุงูุซุงููู ุงุฏุจู</option>
              <option value="ุงูุตู ุงูุซุงูุซ ุงูุซุงููู ุนููู">ุงูุตู ุงูุซุงูุซ ุงูุซุงููู ุนููู</option>
              <option value="ุงูุตู ุงูุซุงูุซ ุงูุซุงููู ุงุฏุจู">ุงูุตู ุงูุซุงูุซ ุงูุซุงููู ุงุฏุจู</option>
            </select>
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">ุงูููู</label>
            <select id="day" name="day" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white" required>
              <option value="" disabled selected>ุงุฎุชุฑ ุงูููู</option>
              <option value="ุงูุฃุญุฏ">ุงูุฃุญุฏ</option>
              <option value="ุงูุงุซููู">ุงูุงุซููู</option>
              <option value="ุงูุซูุงุซุงุก">ุงูุซูุงุซุงุก</option>
              <option value="ุงูุฃุฑุจุนุงุก">ุงูุฃุฑุจุนุงุก</option>
              <option value="ุงูุฎููุณ">ุงูุฎููุณ</option>
            </select>
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">ุงููุงุฏุฉ</label>
            <input id="subject" name="subject" type="text" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ูุซุงู: ุงูุฑูุงุถูุงุชุ ุงูููุฒูุงุกุ ุงูููููุงุก" required />
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">ุงูุชุงุฑูุฎ</label>
            <input id="date" name="date" type="date" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500" required />
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">ุงูููุช ูู</label>
            <input id="timeFrom" name="timeFrom" type="time" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" required />
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">ุงูููุช ุฅูู</label>
            <input id="timeTo" name="timeTo" type="time" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500" required />
          </div>
        </div>
        <div class="flex items-center justify-between pt-2 relative z-10">
          <div class="text-xs text-gray-500">ุณูุชู ุญูุธ ุงูุฌุฏูู ุงูุฏุฑุงุณู ููุฑุงู ูุฑุจุทู ุจุญุณุงุจู</div>
          <div class="flex gap-3">
            <a href="javascript:goBack()" class="px-4 py-2 rounded-lg border text-sm hover:bg-gray-50">ุฑุฌูุน</a>
            <button id="createScheduleBtn" type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 flex items-center gap-2">๐พ ุญูุธ</button>
          </div>
      </form>
    </div>
  </main>
  
  <div id="notificationRoot" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // ุญุฑุงุณุฉ ุงููุตูู
    (function guard(){
      const attempt=()=>{
        if(!(window.AUTH && AUTH.getCurrentUser)) return setTimeout(attempt,40);
        const user = AUTH.getCurrentUser();
        if(!user){
          localStorage.setItem('postLoginRedirect','add-schedule-simple.html');
          return window.location.href='index_updated.html';
        }
        const role=(user.role||'').toLowerCase();
        const allowed=['instructor','admin','teacher','ูุฏุฑุณ','ูุนูู'];
        if(!allowed.includes(role)){
          document.getElementById('accessDenied').classList.remove('hidden');
          return; // ูุง ูุนุฑุถ ุงูููุฑู
        }
        document.getElementById('pageHeader').classList.remove('hidden');
        document.getElementById('scheduleFormWrapper').classList.remove('hidden');
      };
      attempt();
    })();

    // ุชุญููู ุงูู Shared Header ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof loadSharedHeader === 'function') {
        loadSharedHeader();
      }
      
      // Set minimum date to today
      document.getElementById('date').min = new Date().toISOString().split('T')[0];
    });

    const form = document.getElementById('scheduleForm');
    form?.addEventListener('submit', submitNewSchedule);

    async function submitNewSchedule(e){
      e.preventDefault();
      const btn=document.getElementById('createScheduleBtn');
      btn.disabled=true; const original=btn.innerHTML; btn.innerHTML='โณ ุฌุงุฑู ุงูุญูุธ...';
      
      try {
        const fd=new FormData(form);
        const data={
          grade: fd.get('grade'),
          day: fd.get('day'),
          subject: (fd.get('subject')||'').trim(),
          date: fd.get('date'),
          timeFrom: fd.get('timeFrom'),
          timeTo: fd.get('timeTo'),
          createdBy: (function(){ try { const u=AUTH.getCurrentUser(); return u? (u._id||u.id||u.userId):undefined;}catch(_){return undefined;} })()
        };
        
        if(!data.grade || !data.day || !data.subject || !data.date || !data.timeFrom || !data.timeTo){
          notify('ูุฑุฌู ููุก ุฌููุน ุงูุญููู','error');
          return;
        }
        
        // Validation
        if (data.timeFrom >= data.timeTo) {
          notify('ููุช ุงูุจุฏุงูุฉ ูุฌุจ ุฃู ูููู ูุจู ููุช ุงูููุงูุฉ','error');
          return;
        }
        
        // Get auth token
        const token = localStorage.getItem('authToken') || 
                     localStorage.getItem('token') || 
                     localStorage.getItem('jwt') || 
                     localStorage.getItem('accessToken');

        if (!token) {
          notify('ูุง ููุฌุฏ ุฑูุฒ ูุตุงุฏูุฉ','error');
          return;
        }
        
        const response = await fetch('https://courses-nine-eta.vercel.app/api/schedule', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          notify('โ ุชู ุฅุถุงูุฉ ุงูุฌุฏูู ุงูุฏุฑุงุณู ุจูุฌุงุญ','success');
          
          // Wait a bit then redirect
          setTimeout(() => {
            const referrer = document.referrer;
            if (referrer && referrer.includes('grade')) {
              window.history.back();
            } else {
              window.location.href = 'grades.html';
            }
          }, 1200);
        } else {
          let errorMessage = 'ูุดู ูู ุฅุถุงูุฉ ุงูุฌุฏูู';
          try {
            const error = await response.json();
            errorMessage = error.message || errorMessage;
          } catch (e) {
            console.warn('Could not parse error response:', e);
          }
          throw new Error(errorMessage);
        }
        
      } catch(err){
        console.error(err);
        notify('โ ' + (err.message || 'ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงูุฌุฏูู'),'error');
      } finally {
        btn.disabled=false; btn.innerHTML=original;
      }
    }

    function goBack() {
      const referrer = document.referrer;
      if (referrer && referrer.includes('grade')) {
        window.history.back();
      } else {
        window.location.href = 'grades.html';
      }
    }

    function notify(msg, type='info'){
      const root=document.getElementById('notificationRoot');
      const el=document.createElement('div');
      el.className=`px-5 py-3 rounded-lg shadow text-sm text-white transition transform ${type==='error'?'bg-red-600':type==='success'?'bg-green-600':'bg-indigo-600'}`;
      el.textContent=msg; root.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateX(100%)'; setTimeout(()=>el.remove(),300); },3000);
    }

    // ุชุณุฌูู ุฎุฑูุฌ
    document.getElementById('logoutBtn')?.addEventListener('click',()=>{ try { AUTH.logout(); } catch(_){} window.location.href='index_updated.html'; });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('scheduleForm')?.dispatchEvent(new Event('submit'));
      }
      if (e.key === 'Escape') {
        goBack();
      }
    });
  </script>
</body>
</html>