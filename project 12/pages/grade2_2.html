<!DOCTYPE html>
<html lang="ar" dir="rtl" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>الصف الثاني الثانوي أدبي - منصتي التعليمية</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="../js/auth.js"></script>
  <script src="../js/lessons.js"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #dbeafe, #e0e7ff, #e0f2fe);
      transition: background 0.5s ease;
    }
    html.dark body {
      background: linear-gradient(to bottom right, #0f172a, #1e1b4b, #1e3a8a);
    }
    .card { transition: all 0.3s ease; }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .nav-tab.active {
      background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
      color: #fff;
    }
    .schedule-time {
      background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
    }
    .teacher-mode-indicator {
      position: absolute;
      top: -8px;
      right: -8px;
      background: linear-gradient(135deg, #8b5cf6, #a855f7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .teacher-tools {
      border-top: 2px dashed #8b5cf6;
      background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
      margin-top: 1rem;
      padding-top: 1rem;
    }
    html.dark .teacher-tools {
      background: linear-gradient(135deg, #374151, #4b5563);
    }
    html.dark .text-gray-800 { color: #e2e8f0; }
    html.dark .text-gray-600 { color: #94a3b8; }
    html.dark .bg-white { background-color: #1e293b; }
    html.dark .bg-gray-50 { background-color: #334155; }
    html.dark .text-gray-700 { color: #cbd5e1; }
    #themeToggle {
      position: fixed; top: 20px; left: 20px;
      background: rgba(255, 255, 255, 0.8);
      border: none; border-radius: 9999px;
      width: 50px; height: 50px; cursor: pointer;
      font-size: 1.5rem; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: background 0.3s ease; z-index: 1000;
    }
    #themeToggle:hover { background: rgba(255, 255, 255, 1); }
    html.dark #themeToggle { background: rgba(30, 41, 59, 0.8); color: #e2e8f0; }
    html.dark #themeToggle:hover { background: rgba(30, 41, 59, 1); }

    /* Schedule Card Styles */
    .schedule-card {
      border-left: 4px solid #4CAF50;
      padding: 1rem;
    }

    /* Modal Styles */
    .modal {
      background: rgba(0, 0, 0, 0.5);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .modal h3 {
      margin-bottom: 1.5rem;
      color: #2c3e50;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: #555;
      font-weight: bold;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      direction: rtl;
      text-align: right;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
    }

    .form-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-secondary:hover {
      background: #7f8c8d;
    }

    .hidden {
      display: none !important;
    }

    /* Notification Styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      color: white;
      z-index: 1001;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }

    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }

    .notification.success {
      background: #27ae60;
    }

    .notification.error {
      background: #e74c3c;
    }

    .notification.warning {
      background: #f39c12;
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- زر الوضع الليلي -->
  <button id="themeToggle" aria-label="تبديل الوضع بين داكن وفاتح">🌙</button>

  <!-- بانر ترحيب -->
  <section id="welcomeBox" class="container mx-auto mt-6 hidden">
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 rounded-lg shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
      <span id="welcomeText" class="font-semibold text-lg text-center md:text-right"></span>
      <button id="logoutBtn" class="bg-white text-blue-600 px-4 py-2 rounded-lg shadow hover:bg-gray-100 w-full md:w-auto">تسجيل الخروج</button>
    </div>
  </section>

  <!-- Header -->
  <header class="bg-white shadow-lg">
    <div class="container mx-auto px-4 py-4 flex flex-col lg:flex-row justify-between items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
          <i class="fas fa-graduation-cap text-white text-xl"></i>
        </div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold text-gray-800">الصف الثاني الثانوي أدبي</h1>
          <p class="text-gray-600 text-sm md:text-base">منصتي التعليمية</p>
        </div>
      </div>
      <div class="flex flex-col md:flex-row items-center gap-4">
        <!-- منيو الطالب -->
        <div class="relative inline-block text-left">
          <button id="userMenuBtn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-full shadow hover:bg-blue-700 w-full md:w-auto justify-center">
            <span id="studentName">👤 الطالب</span>
            <i class="fas fa-caret-down"></i>
          </button>
          <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 bg-white border rounded-lg shadow-lg">
            <a href="profile.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">الملف الشخصي</a>
            <a href="grades.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">الدرجات</a>
            <a href="calendar.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">التقويم</a>
            <a href="settings.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">الإعدادات</a>
            <hr>
            <button id="logoutBtn2" class="w-full text-right px-4 py-2 text-red-600 hover:bg-red-100">تسجيل الخروج</button>
          </div>
        </div>
        <!-- بيانات الأستاذ + زر التبديل -->
        <div class="flex items-center gap-3">
          <!-- زر إضافة حصة للمعلمين فقط -->
          <div id="addLessonHeaderBtn" class="hidden">
            <a href="add-lesson.html" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
              <i class="fas fa-plus"></i>
              <span>إضافة حصة</span>
            </a>
          </div>
          
          <!-- زر إضافة جدول دراسي للمعلمين فقط -->
          <div id="addScheduleHeaderBtn" class="hidden">
            <a href="add-schedule-simple.html" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
              <i class="fas fa-calendar-plus"></i>
              <span>إضافة جدول</span>
            </a>
          </div>
          
          <!-- زر إضافة واجب للمعلمين فقط -->
          <div id="addHomeworkHeaderBtn" class="hidden">
            <a href="add-homework.html" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
              <i class="fas fa-tasks"></i>
              <span>إضافة واجب</span>
            </a>
          </div>

          <!-- زر إضافة كويز للمعلمين فقط -->
          <div id="addQuizHeaderBtn" class="hidden">
            <a href="add-quiz.html" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
              <i class="fas fa-question-circle"></i>
              <span>إضافة كويز</span>
            </a>
          </div>
          
          <div class="relative">
            <img src="../images/photo_2025-09-03_00-20-27.jpg" class="w-12 h-12 rounded-full border-2 border-blue-400" alt="أ/ مجدي جمال" />
            <div id="teacherModeIndicator" class="teacher-mode-indicator hidden">مدرس</div>
          </div>
          <div class="text-right">
            <p class="font-semibold text-gray-800">أ/ مجدي جمال</p>
            <p class="text-sm text-gray-600">مدرس الرياضيات</p>
          </div>

        </div>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="bg-white shadow-md mt-4 overflow-x-auto">
    <div class="container mx-auto px-4 py-3 flex space-x-4 space-x-reverse min-w-max md:min-w-0 justify-start md:justify-center">
      <button class="nav-tab active px-4 py-2 rounded-lg font-semibold whitespace-nowrap" data-tab="lessons">🎓 الحصص</button>
      <button class="nav-tab px-4 py-2 rounded-lg font-semibold whitespace-nowrap" data-tab="schedule">📅 الجدول الدراسي</button>
      <button class="nav-tab px-4 py-2 rounded-lg font-semibold whitespace-nowrap" data-tab="homework">📝 الواجبات</button>
      <button class="nav-tab px-4 py-2 rounded-lg font-semibold whitespace-nowrap" data-tab="materials">📚 المواد التعليمية</button>
      <button class="nav-tab px-4 py-2 rounded-lg font-semibold whitespace-nowrap" data-tab="quizzes">🎯 الكويزات</button>
    </div>
  </nav>

  <!-- Main -->
  <main class="container mx-auto px-4 py-8">
    <!-- Lessons -->
    <div id="lessons-tab" class="tab-content">
      <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">الحصص</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="lessonsGrid">
        <!-- Lesson cards will be generated by JavaScript -->
      </div>
    </div>

    <!-- Schedule -->
    <div id="schedule-tab" class="tab-content hidden">
      <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">الجدول الدراسي</h2>
      
      <!-- Teacher Tools for Schedule -->
      <div id="scheduleTeacherTools" class="teacher-tools rounded-lg p-4 mb-6 hidden">
        <h3 class="text-lg font-bold text-purple-800 mb-4">🛠️ أدوات المدرس - إدارة الجدول</h3>
        <div class="flex flex-col md:flex-row gap-4">
          <input type="text" id="scheduleDay" placeholder="اليوم (مثال: الأحد)" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" />
          <input type="text" id="scheduleSubject" placeholder="المادة" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" />
          <input type="time" id="scheduleTimeStart" class="px-3 py-2 border border-gray-300 rounded-md" />
          <input type="time" id="scheduleTimeEnd" class="px-3 py-2 border border-gray-300 rounded-md" />
          <button onclick="addScheduleItem()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">➕ إضافة</button>
        </div>
      </div>

      <div id="scheduleGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Schedule items will be generated by JavaScript -->
      </div>
    </div>

    <!-- Homework -->
    <div id="homework-tab" class="tab-content hidden">
      <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">الواجبات</h2>
      
      <!-- Teacher Tools for Homework -->
      <div id="homeworkTeacherTools" class="teacher-tools rounded-lg p-4 mb-6 hidden">
        <h3 class="text-lg font-bold text-purple-800 mb-4">🛠️ أدوات المدرس - إدارة الواجبات</h3>
        <div class="flex flex-col md:flex-row gap-4">
          <input type="text" id="homeworkSubject" placeholder="المادة" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" />
          <textarea id="homeworkDescription" placeholder="وصف الواجب" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" rows="2"></textarea>
          <input type="date" id="homeworkDueDate" class="px-3 py-2 border border-gray-300 rounded-md" />
          <button onclick="addHomework()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">➕ إضافة</button>
        </div>
      </div>

      <div id="homeworkGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Homework items will be generated by JavaScript -->
      </div>
    </div>

    <!-- Materials -->
    <div id="materials-tab" class="tab-content hidden">
      <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">المواد التعليمية</h2>
      
      <!-- Teacher Tools for Materials -->
      <div id="materialsTeacherTools" class="teacher-tools rounded-lg p-4 mb-6 hidden">
        <h3 class="text-lg font-bold text-purple-800 mb-4">🛠️ أدوات المدرس - إدارة المواد</h3>
        <div class="flex flex-col md:flex-row gap-4">
          <input type="text" id="materialTitle" placeholder="عنوان المادة" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" />
          <input type="text" id="materialDescription" placeholder="وصف المادة" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" />
          <input type="url" id="materialLink" placeholder="رابط الملف أو PDF" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" />
          <button onclick="addMaterial()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">➕ إضافة</button>
        </div>
      </div>

      <div id="materialsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Material items will be generated by JavaScript -->
      </div>
    </div>

    <!-- Quizzes -->
    <div id="quizzes-tab" class="tab-content hidden">
      <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">الكويزات</h2>
      
      <!-- Teacher Tools for Quizzes -->
      <div id="quizzesTeacherTools" class="teacher-tools rounded-lg p-4 mb-6 hidden">
        <h3 class="text-lg font-bold text-purple-800 mb-4">🛠️ أدوات المدرس - إدارة الكويزات</h3>
        <div class="flex flex-col md:flex-row gap-4">
          <input type="text" id="quizTitle" placeholder="عنوان الكويز" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" />
          <textarea id="quizDescription" placeholder="وصف الكويز" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" rows="2"></textarea>
          <select id="quizStatus" class="px-3 py-2 border border-gray-300 rounded-md">
            <option value="متاح">متاح</option>
            <option value="قريباً">قريباً</option>
            <option value="مغلق">مغلق</option>
          </select>
          <button onclick="addQuiz()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">➕ إضافة</button>
        </div>
      </div>

      <div id="quizzesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Quiz items will be generated by JavaScript -->
      </div>
    </div>
  </main>

  <!-- JS -->
  <script>
    // Global state
    let isTeacherMode = false;
    
    // Data structures
    // Dynamic lessons system
    let lessons = [];
    let lessonsLoading = false;
    let lessonsError = null;
    let currentLessonUnit = '';
    let currentLessonSearch = '';
    let currentLessonPage = 1;
    const LESSONS_PAGE_SIZE = 10;
    
    // Dynamic schedule system
    let schedules = [];
    let schedulesLoading = false;
    let schedulesError = null;
    
    // Dynamic homework system
    let homework = [];
    let homeworkLoading = false;
    let homeworkError = null;
    
    // Load lessons from grade-specific API endpoint
    async function loadLessons(){
      if(lessonsLoading) return;
      lessonsLoading = true;
      lessonsError = null;
      const grid = document.getElementById('lessonsGrid');
      grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-600">جارٍ تحميل الحصص...</div>`;
      try {
        // Use grade-specific endpoint for 2nd secondary literary
        const resp = await fetch('https://courses-nine-eta.vercel.app/api/lessons/grade/2nd-secondary-literary');
        const data = await resp.json();
        lessons = (data.data || data.lessons || []).map(l=>{ if(!l.id && l._id) l.id = l._id; return l; });
        renderAllContent();
      } catch(e){
        lessonsError = e;
        console.error('Load lessons error:', e);
        grid.innerHTML = `<div class='col-span-full text-center py-10 text-red-600'>فشل تحميل الحصص <button class='underline' onclick='loadLessons()'>إعادة المحاولة</button></div>`;
      } finally {
        lessonsLoading = false;
      }
    }
    
    // Load schedules from API
    async function loadSchedules(){
      if(schedulesLoading) return;
      schedulesLoading = true;
      schedulesError = null;
      
      try {
        const token = localStorage.getItem('authToken') || '';
        const resp = await fetch('https://courses-nine-eta.vercel.app/api/schedule/grade/2nd-secondary-arts', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        const data = await resp.json();
        schedules = (data.schedules || []).map(s=>{ if(!s.id && s._id) s.id = s._id; return s; });
        renderSchedule();
      } catch(e){
        schedulesError = e;
        console.error('Load schedules error:', e);
        // Fallback to local storage if API fails
        const localSchedules = JSON.parse(localStorage.getItem('scheduleItems_grade2art') || '[]');
        schedules = localSchedules;
        renderSchedule();
      } finally {
        schedulesLoading = false;
      }
    }
    
    // Load homework from API
    async function loadHomework(){
      if(homeworkLoading) return;
      homeworkLoading = true;
      homeworkError = null;
      const grid = document.getElementById('homeworkGrid');
      grid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-600">جارٍ تحميل الواجبات...</div>`;
      try {
        // Use grade-specific endpoint for 2nd secondary arts
        const resp = await fetch('https://courses-nine-eta.vercel.app/api/tasks/grade/second-secondary-literature');
        const data = await resp.json();
        homework = (data.data || data.tasks || []).map(h=>{ if(!h.id && h._id) h.id = h._id; return h; });
        renderHomework();
      } catch(e){
        homeworkError = e;
        console.error('Load homework error:', e);
        grid.innerHTML = `<div class='col-span-full text-center py-10 text-red-600'>فشل تحميل الواجبات <button class='underline' onclick='loadHomework()'>إعادة المحاولة</button></div>`;
      } finally {
        homeworkLoading = false;
      }
    }

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", () => {
      // Check global teacher mode from localStorage
      const globalTeacherMode = localStorage.getItem('globalTeacherMode') === 'true';
      if (globalTeacherMode) {
        isTeacherMode = true;
        updateModeDisplay();
      }

      loadLessons();
      loadSchedules();
      loadHomework();
      
      // Show add lesson header button for authorized users
      if (window.LessonsAPI && LessonsAPI.canManage()) {
        const addLessonHeaderBtn = document.getElementById('addLessonHeaderBtn');
        if (addLessonHeaderBtn) {
          addLessonHeaderBtn.classList.remove('hidden');
        }
        
        const addScheduleHeaderBtn = document.getElementById('addScheduleHeaderBtn');
        function showHeaderButtons() {
          // Check if user is authorized using multiple methods
          let canManage = false;
          if (window.LessonsAPI && LessonsAPI.canManage) {
            try { canManage = LessonsAPI.canManage(); } catch(e) {}
          }
          if (!canManage) canManage = localStorage.getItem('globalTeacherMode') === 'true';
          if (!canManage) {
            try {
              const userData = localStorage.getItem('user') || localStorage.getItem('userData');
              if (userData) {
                const user = JSON.parse(userData);
                const role = (user.role || '').toLowerCase();
                canManage = ['instructor', 'admin', 'teacher', 'مدرس', 'معلم'].includes(role);
              }
            } catch(e) {}
          }
          if (!canManage) canManage = isTeacherMode === true;
          if (canManage) {
            const addLessonHeaderBtn = document.getElementById('addLessonHeaderBtn');
            if (addLessonHeaderBtn) addLessonHeaderBtn.classList.remove('hidden');
            const addScheduleHeaderBtn = document.getElementById('addScheduleHeaderBtn');
            if (addScheduleHeaderBtn) addScheduleHeaderBtn.classList.remove('hidden');
            const addHomeworkHeaderBtn = document.getElementById('addHomeworkHeaderBtn');
            if (addHomeworkHeaderBtn) addHomeworkHeaderBtn.classList.remove('hidden');
            const addQuizHeaderBtn = document.getElementById('addQuizHeaderBtn');
            if (addQuizHeaderBtn) addQuizHeaderBtn.classList.remove('hidden');
          }
        }
        modeText.textContent = '🎓 وضع المدرس';
        indicator.classList.add('hidden');
        hideTeacherTools();
      }
    }

    // Show/Hide teacher tools
    function showTeacherTools() {
      document.getElementById('scheduleTeacherTools').classList.remove('hidden');
      document.getElementById('homeworkTeacherTools').classList.remove('hidden');
      document.getElementById('materialsTeacherTools').classList.remove('hidden');
      document.getElementById('quizzesTeacherTools').classList.remove('hidden');
    }

    function hideTeacherTools() {
      document.getElementById('scheduleTeacherTools').classList.add('hidden');
      document.getElementById('homeworkTeacherTools').classList.add('hidden');
      document.getElementById('materialsTeacherTools').classList.add('hidden');
      document.getElementById('quizzesTeacherTools').classList.add('hidden');
    }

    // Render all content
    function renderAllContent() {
      async function renderQuizzes() {
        const quizzesGrid = document.getElementById('quizzesGrid');
        quizzesGrid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-600">جارٍ تحميل الكويزات...</div>';
        let quizzes = [];
        try {
          const resp = await fetch('https://courses-nine-eta.vercel.app/api/quizzes/grade/second-secondary-literature');
          const data = await resp.json();
          quizzes = data.data || [];
        } catch (e) {
          quizzesGrid.innerHTML = '<div class="col-span-full text-center py-10 text-red-600">فشل تحميل الكويزات</div>';
          return;
        }
        if (quizzes.length === 0) {
          quizzesGrid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">لا توجد كويزات متاحة</div>';
          return;
        }
        quizzesGrid.innerHTML = '';
        quizzes.forEach((quiz, index) => {
          const quizCard = document.createElement('div');
          quizCard.className = 'card bg-white rounded-xl shadow-lg p-6 border-yellow-400 relative';
          const status = quiz.isActive === false ? 'مغلق' : 'متاح';
          const statusColors = {
            'متاح': 'bg-yellow-100 text-yellow-800',
            'قريباً': 'bg-blue-100 text-blue-800',
            'مغلق': 'bg-red-100 text-red-800'
          };
          quizCard.innerHTML = `
            ${(window.LessonsAPI && LessonsAPI.canManage && LessonsAPI.canManage()) ? '<div class=\"teacher-mode-indicator\">قابل للتعديل</div>' : ''}
            <div class=\"flex items-center justify-between mb-4\">
              <h3 class=\"text-xl font-bold text-yellow-800\">${quiz.title}</h3>
              <span class=\"px-3 py-1 ${statusColors[status]} rounded-full text-sm\">${status}</span>
              ${(window.LessonsAPI && LessonsAPI.canManage && LessonsAPI.canManage()) ? `
                <div class='relative'>
                  <button class='text-gray-500 hover:text-gray-700 px-2' onclick=\"this.nextElementSibling.classList.toggle('hidden')\">⋮</button>
                  <div class='hidden absolute left-0 mt-1 w-32 bg-white border rounded shadow z-10'>
                    <button class='block w-full text-right px-3 py-1 text-sm hover:bg-gray-100' onclick='editQuiz("${quiz._id}")'>✏️ تعديل</button>
                    <button class='block w-full text-right px-3 py-1 text-sm text-red-600 hover:bg-red-100' onclick='removeQuiz("${quiz._id}")'>🗑️ حذف</button>
                  </div>
                </div>
              ` : ''}
            </div>
            <p class=\"text-gray-700 mb-4\">${quiz.description || ''}</p>
            <div class=\"flex justify-between items-center\">
              ${status === 'متاح' ? `
                <button class=\"bg-yellow-500 text-white px-4 py-2 rounded-lg shadow hover:bg-yellow-600 flex-1\" onclick=\"startQuiz('${quiz._id}')\">ابدأ الآن</button>
              ` : `
                <button disabled class=\"bg-gray-400 text-white px-4 py-2 rounded-lg shadow cursor-not-allowed flex-1\">${status}</button>
              `}
            </div>
          `;
          quizzesGrid.appendChild(quizCard);
        });
      }
                id="link_${lesson.id}" 
                value="${savedLink}"
                placeholder="https://youtube.com/watch?v=..."
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button 
                onclick="saveLink('${lesson.id}')"
                class="px-3 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition-colors"
              >
                💾 حفظ
              </button>
            </div>
          </div>
        ` : ''}
        
        <div class="flex justify-between items-center">
          ${savedLink || videoUrl ? `
            <button 
              onclick="openLessonDetail('${lesson.id || lesson._id}')"
              class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
            >
              ▶️ مشاهدة الدرس
            </button>
          ` : `
            <button 
              disabled
              class="flex-1 bg-gray-400 text-white px-4 py-2 rounded-lg cursor-not-allowed flex items-center justify-center gap-2"
            >
              ❌ لا يوجد فيديو متاح
            </button>
          `}
          
          ${isTeacherMode && savedLink ? `
            <button 
              onclick="removeLink('${lesson.id}')"
              class="mr-2 px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm"
            >
              🗑️
            </button>
          ` : ''}
        </div>
      `;
      
      return card;
    }

    // Render schedule
    function renderSchedule() {
      const scheduleGrid = document.getElementById('scheduleGrid');
      
      if(!schedules || schedules.length === 0){
        scheduleGrid.innerHTML = `<div class='col-span-full text-center py-10 text-gray-500'>لا توجد جداول دراسية متاحة حالياً</div>`;
        return;
      }
      
      scheduleGrid.innerHTML = '';
      
      // Group by day
      const groupedByDay = schedules.reduce((acc, item) => {
        const day = item.day;
        if (!acc[day]) acc[day] = [];
        acc[day].push(item);
        return acc;
      }, {});
      
      Object.keys(groupedByDay).forEach(day => {
        const dayCard = document.createElement('div');
        dayCard.className = 'bg-white rounded-xl shadow-lg overflow-hidden';
        
        let dayContent = `
          <div class="schedule-time px-4 py-3 text-white text-center">
            <h3 class="font-bold text-lg">${day}</h3>
          </div>
          <div class="p-4 space-y-3">
        `;
        
        groupedByDay[day].forEach((item) => {
          const colors = day === 'الأحد' ? 'blue' : 'indigo';
          const canManage = window.LessonsAPI && LessonsAPI.canManage();
          
          dayContent += `
            <div class="card bg-${colors}-50 border-l-4 border-${colors}-400 p-3 rounded-lg relative">
              ${canManage ? '<div class="teacher-mode-indicator">قابل للتعديل</div>' : ''}
              <div class="flex justify-between items-center">
                <div class="flex-1">
                  <span class="font-semibold text-${colors}-800">${item.subject}</span>
                  <div class="text-sm text-${colors}-600">${item.timeFrom} - ${item.timeTo}</div>
                  ${item.date ? `<div class="text-xs text-${colors}-500">${new Date(item.date).toLocaleDateString('ar-EG')}</div>` : ''}
                </div>
                ${canManage ? `
                  <div class='relative'>
                    <button class='text-gray-500 hover:text-gray-700 px-2' onclick="this.nextElementSibling.classList.toggle('hidden')">⋮</button>
                    <div class='hidden absolute left-0 mt-1 w-32 bg-white border rounded shadow z-10'>
                      <button class='block w-full text-right px-3 py-1 text-sm hover:bg-gray-100' onclick='editScheduleItem("${item.id || item._id}")'>✏️ تعديل</button>
                      <button class='block w-full text-right px-3 py-1 text-sm text-red-600 hover:bg-red-100' onclick='deleteScheduleItem("${item.id || item._id}")'>🗑️ حذف</button>
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        });
        
        dayContent += '</div>';
        dayCard.innerHTML = dayContent;
        scheduleGrid.appendChild(dayCard);
      });
    }

    // Render homework
    function renderHomework() {
      const homeworkGrid = document.getElementById('homeworkGrid');
      homeworkGrid.innerHTML = '';
      
      if(!homework || homework.length === 0){
        homeworkGrid.innerHTML = `<div class='col-span-full text-center py-10 text-gray-500'>لا توجد واجبات متاحة حالياً</div>`;
        return;
      }
      
      homework.forEach((item, index) => {
        const homeworkCard = document.createElement('div');
        homeworkCard.className = 'card bg-white rounded-xl shadow-lg p-6 border-blue-400 relative';
        
        // Get data from API response or fallback to defaults
        const taskTitle = item.taskTitle || item.title || 'واجب بدون عنوان';
        const taskSubject = item.subject || item.taskSubject || 'مادة غير محددة';
        const taskDescription = item.taskDescription || item.description || '';
        const dueDate = item.dueDate ? new Date(item.dueDate).toLocaleDateString('ar-EG') : 'غير محدد';
        
        // Calculate status based on due date
        let status = 'متاح';
        if (item.dueDate) {
          const due = new Date(item.dueDate);
          const now = new Date();
          const diffTime = due - now;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays < 0) status = 'منتهي الصلاحية';
          else if (diffDays === 0) status = 'اليوم';
          else if (diffDays === 1) status = 'غداً';
          else if (diffDays <= 7) status = `خلال ${diffDays} أيام`;
          else status = 'الأسبوع القادم';
        }
        
        const colors = taskSubject === 'تاريخ' ? 'blue' : taskSubject === 'جغرافيا' ? 'green' : 'indigo';
        const canManage = window.LessonsAPI && LessonsAPI.canManage();
        
        homeworkCard.innerHTML = `
          ${canManage ? '<div class="teacher-mode-indicator">قابل للتعديل</div>' : ''}
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-${colors}-800">${taskTitle}</h3>
            <span class="px-3 py-1 bg-${colors}-100 text-${colors}-800 rounded-full text-sm">${status}</span>
          </div>
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-600">المادة:</span>
            <span class="text-sm text-${colors}-600">${taskSubject}</span>
          </div>
          <p class="text-gray-700 mb-4">${taskDescription}</p>
          <p class="text-sm text-gray-600 mb-4">تاريخ التسليم: ${dueDate}</p>
          ${canManage ? `
            <div class="teacher-tools rounded-lg p-3">
              <div class='flex gap-2'>
                <button 
                  onclick="editHomework('${item.id || item._id}')"
                  class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm"
                >
                  ✏️ تعديل
                </button>
                <button 
                  onclick="deleteHomework('${item.id || item._id}')"
                  class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm"
                >
                  🗑️ حذف
                </button>
              </div>
            </div>
          ` : ''}
        `;
        
        homeworkGrid.appendChild(homeworkCard);
      });
    }

    // Render materials
    function renderMaterials() {
      const materialsGrid = document.getElementById('materialsGrid');
      const materials = JSON.parse(localStorage.getItem('materials_grade2art') || '[]');
      
      // Default materials if empty
      if (materials.length === 0) {
        materials.push({
          title: 'ملخص التاريخ',
          description: 'الثورة العرابية',
          files: [
            { name: 'أسئلة مراجعة.pdf', link: '#' }
          ]
        });
      }
      
      materialsGrid.innerHTML = '';
      
      materials.forEach((material, index) => {
        const materialCard = document.createElement('div');
        materialCard.className = 'card bg-white rounded-xl shadow-lg p-6 relative';
        
        let filesHtml = '';
        material.files.forEach((file, fileIndex) => {
          filesHtml += `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <span class="text-sm">${file.name}</span>
              <div class="flex gap-2">
                <button onclick="downloadFile('${file.link}')" class="text-blue-600 hover:text-indigo-600"><i class="fas fa-download"></i></button>
                ${isTeacherMode ? `
                  <button onclick="removeMaterialFile(${index}, ${fileIndex})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                ` : ''}
              </div>
            </div>
          `;
        });
        
        materialCard.innerHTML = `
          ${isTeacherMode ? '<div class="teacher-mode-indicator">قابل للتعديل</div>' : ''}
          <div class="text-center mb-4">
            <i class="fas fa-file-pdf text-blue-500 text-4xl mb-2"></i>
            <h3 class="font-bold text-gray-800">${material.title}</h3>
            <p class="text-sm text-gray-600">${material.description}</p>
          </div>
          <div class="space-y-2">
            ${filesHtml}
          </div>
          ${isTeacherMode ? `
            <div class="teacher-tools rounded-lg p-3 mt-4">
              <button 
                onclick="removeMaterial(${index})"
                class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm"
              >
                🗑️ حذف المجموعة
              </button>
            </div>
          ` : ''}
        `;
        
        materialsGrid.appendChild(materialCard);
      });
    }


// Teacher tools functions

function editQuiz(quizId) {
  window.location.href = `add-quiz.html?edit=${quizId}`;
}
function removeQuiz(quizId) {
  if (!confirm('هل أنت متأكد من حذف هذا الكويز؟')) return;
  // TODO: حذف من API
  alert('سيتم حذف الكويز من الخادم: ' + quizId);
}
function startQuiz(quizId) {
  // توجيه الطالب لصفحة حل الكويز
  window.location.href = `quiz.html?id=${quizId}`;
}
function addScheduleItem() {
  const day = document.getElementById('scheduleDay').value.trim();
  const subject = document.getElementById('scheduleSubject').value.trim();
  const startTime = document.getElementById('scheduleTimeStart').value;
  const endTime = document.getElementById('scheduleTimeEnd').value;
  if (!day || !subject || !startTime || !endTime) {
    showNotification('يرجى ملء جميع الحقول', 'error');
    return;
  }
  const scheduleItems = JSON.parse(localStorage.getItem('scheduleItems_grade2art') || '[]');
  scheduleItems.push({ day, subject, startTime, endTime });
  localStorage.setItem('scheduleItems_grade2art', JSON.stringify(scheduleItems));
  // Clear inputs
  document.getElementById('scheduleDay').value = '';
  document.getElementById('scheduleSubject').value = '';
  document.getElementById('scheduleTimeStart').value = '';
  document.getElementById('scheduleTimeEnd').value = '';
  renderSchedule();
  showNotification('تمت إضافة الجلسة بنجاح', 'success');
}

function addHomework() {
      const subject = document.getElementById('homeworkSubject').value.trim();
      const description = document.getElementById('homeworkDescription').value.trim();
      const dueDate = document.getElementById('homeworkDueDate').value;
      
      if (!subject || !description || !dueDate) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      
      const homeworkItems = JSON.parse(localStorage.getItem('homeworkItems_grade2art') || '[]');
      const today = new Date();
      const due = new Date(dueDate);
      const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      
      let status = 'متأخر';
      if (diffDays === 1) status = 'غداً';
      else if (diffDays <= 7 && diffDays > 1) status = 'هذا الأسبوع';
      else if (diffDays > 7) status = 'الأسبوع القادم';
      
      homeworkItems.push({ subject, description, dueDate, status });
      localStorage.setItem('homeworkItems_grade2art', JSON.stringify(homeworkItems));
      
      // Clear inputs
      document.getElementById('homeworkSubject').value = '';
      document.getElementById('homeworkDescription').value = '';
      document.getElementById('homeworkDueDate').value = '';
      
      renderHomework();
      showNotification('تمت إضافة الواجب بنجاح', 'success');
    }

function addMaterial() {
      const title = document.getElementById('materialTitle').value.trim();
      const description = document.getElementById('materialDescription').value.trim();
      const link = document.getElementById('materialLink').value.trim();
      
      if (!title || !description || !link) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      
      const materials = JSON.parse(localStorage.getItem('materials_grade2art') || '[]');
      const fileName = title + '.pdf';
      
      materials.push({
        title,
        description,
        files: [{ name: fileName, link }]
      });
      
      localStorage.setItem('materials_grade2art', JSON.stringify(materials));
      
      // Clear inputs
      document.getElementById('materialTitle').value = '';
      document.getElementById('materialDescription').value = '';
      document.getElementById('materialLink').value = '';
      
      renderMaterials();
      showNotification('تمت إضافة المادة بنجاح', 'success');
    }

function addQuiz() {
      const title = document.getElementById('quizTitle').value.trim();
      const description = document.getElementById('quizDescription').value.trim();
      const status = document.getElementById('quizStatus').value;
      
      if (!title || !description) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      
      const quizzes = JSON.parse(localStorage.getItem('quizzes_grade2art') || '[]');
      quizzes.push({ title, description, status });
      localStorage.setItem('quizzes_grade2art', JSON.stringify(quizzes));
      
      // Clear inputs
      document.getElementById('quizTitle').value = '';
      document.getElementById('quizDescription').value = '';
      document.getElementById('quizStatus').value = 'متاح';
      
      renderQuizzes();
      showNotification('تمت إضافة الكويز بنجاح', 'success');
    }

function removeHomework(index) {
      if (!confirm('هل أنت متأكد من حذف هذا الواجب؟')) return;
      
      const homeworkItems = JSON.parse(localStorage.getItem('homeworkItems_grade2art') || '[]');
      homeworkItems.splice(index, 1);
      localStorage.setItem('homeworkItems_grade2art', JSON.stringify(homeworkItems));
      
      renderHomework();
      showNotification('تم حذف الواجب بنجاح', 'success');
    }

function removeMaterial(index) {
      if (!confirm('هل أنت متأكد من حذف هذه المادة؟')) return;
      
      const materials = JSON.parse(localStorage.getItem('materials_grade2art') || '[]');
      materials.splice(index, 1);
      localStorage.setItem('materials_grade2art', JSON.stringify(materials));
      
      renderMaterials();
      showNotification('تم حذف المادة بنجاح', 'success');
    }

function removeQuiz(index) {
      if (!confirm('هل أنت متأكد من حذف هذا الكويز؟')) return;
      
      const quizzes = JSON.parse(localStorage.getItem('quizzes_grade2art') || '[]');
      quizzes.splice(index, 1);
      localStorage.setItem('quizzes_grade2art', JSON.stringify(quizzes));
      
      renderQuizzes();
      showNotification('تم حذف الكويز بنجاح', 'success');
    }

    // Teacher tools functions
    function editQuiz(quizId) {
      window.location.href = `add-quiz.html?edit=${quizId}`;
    }
    function removeQuiz(quizId) {
      if (!confirm('هل أنت متأكد من حذف هذا الكويز؟')) return;
      // TODO: حذف من API
      alert('سيتم حذف الكويز من الخادم: ' + quizId);
    }
    function startQuiz(quizId) {
      // توجيه الطالب لصفحة حل الكويز
      window.location.href = `quiz.html?id=${quizId}`;
    }
    function addScheduleItem() {
      const day = document.getElementById('scheduleDay').value.trim();
      const subject = document.getElementById('scheduleSubject').value.trim();
      const startTime = document.getElementById('scheduleTimeStart').value;
      const endTime = document.getElementById('scheduleTimeEnd').value;
      if (!day || !subject || !startTime || !endTime) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      const scheduleItems = JSON.parse(localStorage.getItem('scheduleItems_grade2art') || '[]');
      scheduleItems.push({ day, subject, startTime, endTime });
      localStorage.setItem('scheduleItems_grade2art', JSON.stringify(scheduleItems));
      // Clear inputs
      document.getElementById('scheduleDay').value = '';
      document.getElementById('scheduleSubject').value = '';
      document.getElementById('scheduleTimeStart').value = '';
      document.getElementById('scheduleTimeEnd').value = '';
      renderSchedule();
      showNotification('تمت إضافة الجلسة بنجاح', 'success');
    }
    function addHomework() {
      const subject = document.getElementById('homeworkSubject').value.trim();
      const description = document.getElementById('homeworkDescription').value.trim();
      const dueDate = document.getElementById('homeworkDueDate').value;
      if (!subject || !description || !dueDate) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      const homeworkItems = JSON.parse(localStorage.getItem('homeworkItems_grade2art') || '[]');
      const today = new Date();
      const due = new Date(dueDate);
      const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      let status = 'متأخر';
      if (diffDays === 1) status = 'غداً';
      else if (diffDays <= 7 && diffDays > 1) status = 'هذا الأسبوع';
      else if (diffDays > 7) status = 'الأسبوع القادم';
      homeworkItems.push({ subject, description, dueDate, status });
      localStorage.setItem('homeworkItems_grade2art', JSON.stringify(homeworkItems));
      // Clear inputs
      document.getElementById('homeworkSubject').value = '';
      document.getElementById('homeworkDescription').value = '';
      document.getElementById('homeworkDueDate').value = '';
      renderHomework();
      showNotification('تمت إضافة الواجب بنجاح', 'success');
    }
    function addMaterial() {
      const title = document.getElementById('materialTitle').value.trim();
      const description = document.getElementById('materialDescription').value.trim();
      const link = document.getElementById('materialLink').value.trim();
      if (!title || !description || !link) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      const materials = JSON.parse(localStorage.getItem('materials_grade2art') || '[]');
      const fileName = title + '.pdf';
      materials.push({
        title,
        description,
        files: [{ name: fileName, link }]
      });
      localStorage.setItem('materials_grade2art', JSON.stringify(materials));
      // Clear inputs
      document.getElementById('materialTitle').value = '';
      document.getElementById('materialDescription').value = '';
      document.getElementById('materialLink').value = '';
      renderMaterials();
      showNotification('تمت إضافة المادة بنجاح', 'success');
    }
    function addQuiz() {
      const title = document.getElementById('quizTitle').value.trim();
      const description = document.getElementById('quizDescription').value.trim();
      const status = document.getElementById('quizStatus').value;
      if (!title || !description) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      const quizzes = JSON.parse(localStorage.getItem('quizzes_grade2art') || '[]');
      quizzes.push({ title, description, status });
      localStorage.setItem('quizzes_grade2art', JSON.stringify(quizzes));
      // Clear inputs
      document.getElementById('quizTitle').value = '';
      document.getElementById('quizDescription').value = '';
      document.getElementById('quizStatus').value = 'متاح';
      renderQuizzes();
      showNotification('تمت إضافة الكويز بنجاح', 'success');
    }
    function removeHomework(index) {
      if (!confirm('هل أنت متأكد من حذف هذا الواجب؟')) return;
      const homeworkItems = JSON.parse(localStorage.getItem('homeworkItems_grade2art') || '[]');
      homeworkItems.splice(index, 1);
      localStorage.setItem('homeworkItems_grade2art', JSON.stringify(homeworkItems));
      renderHomework();
      showNotification('تم حذف الواجب بنجاح', 'success');
    }
    function removeMaterial(index) {
      if (!confirm('هل أنت متأكد من حذف هذه المادة؟')) return;
      const materials = JSON.parse(localStorage.getItem('materials_grade2art') || '[]');
      materials.splice(index, 1);
      localStorage.setItem('materials_grade2art', JSON.stringify(materials));
      renderMaterials();
      showNotification('تم حذف المادة بنجاح', 'success');
    }
    function removeQuiz(index) {
      if (!confirm('هل أنت متأكد من حذف هذا الكويز؟')) return;
      const quizzes = JSON.parse(localStorage.getItem('quizzes_grade2art') || '[]');
      quizzes.splice(index, 1);
      localStorage.setItem('quizzes_grade2art', JSON.stringify(quizzes));
      renderQuizzes();
      showNotification('تم حذف الكويز بنجاح', 'success');
    }
    function saveLink(lessonId) {
      const linkInput = document.getElementById(`link_${lessonId}`);
      const link = linkInput.value.trim();
      if (link && isValidYouTubeUrl(link)) {
        localStorage.setItem(`lesson_${lessonId}_link`, link);
        renderLessons();
        showNotification('تم حفظ الرابط بنجاح! ✅', 'success');
      } else if (link) {
        showNotification('يرجى إدخال رابط يوتيوب صحيح', 'error');
      } else {
        showNotification('يرجى إدخال رابط', 'error');
      }
    }
    function removeLink(lessonId) {
      if (confirm('هل أنت متأكد من حذف هذا الرابط؟')) {
        localStorage.removeItem(`lesson_${lessonId}_link`);
        renderLessons();
        showNotification('تم حذف الرابط بنجاح', 'success');
      }
    }
    function watchLesson(link) {
      if (link) {
        window.open(link, '_blank');
      }
    }
    function openLessonDetail(id) {
      window.location.href = `lesson.html?id=${encodeURIComponent(id)}`;
    }
    function downloadFile(link) {
      window.open(link, '_blank');
    }
    function isValidYouTubeUrl(url) {
      const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/(watch\?v=|embed\/)|youtu\.be\/).+/;
      return youtubeRegex.test(url);
    }

    // --- نقل جميع الدوال المتبقية إلى نهاية السكريبت ---

    function addHomework() {
      const subject = document.getElementById('homeworkSubject').value.trim();
      const description = document.getElementById('homeworkDescription').value.trim();
      const dueDate = document.getElementById('homeworkDueDate').value;
      if (!subject || !description || !dueDate) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      const homeworkItems = JSON.parse(localStorage.getItem('homeworkItems_grade2art') || '[]');
      const today = new Date();
      const due = new Date(dueDate);
      const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      let status = 'متأخر';
      if (diffDays === 1) status = 'غداً';
      else if (diffDays <= 7 && diffDays > 1) status = 'هذا الأسبوع';
      else if (diffDays > 7) status = 'الأسبوع القادم';
      homeworkItems.push({ subject, description, dueDate, status });
      localStorage.setItem('homeworkItems_grade2art', JSON.stringify(homeworkItems));
      document.getElementById('homeworkSubject').value = '';
      document.getElementById('homeworkDescription').value = '';
      document.getElementById('homeworkDueDate').value = '';
      renderHomework();
      showNotification('تمت إضافة الواجب بنجاح', 'success');
    }

    function addMaterial() {
      const title = document.getElementById('materialTitle').value.trim();
      const description = document.getElementById('materialDescription').value.trim();
      const link = document.getElementById('materialLink').value.trim();
      if (!title || !description || !link) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      const materials = JSON.parse(localStorage.getItem('materials_grade2art') || '[]');
      const fileName = title + '.pdf';
      materials.push({ title, description, files: [{ name: fileName, link }] });
      localStorage.setItem('materials_grade2art', JSON.stringify(materials));
      document.getElementById('materialTitle').value = '';
      document.getElementById('materialDescription').value = '';
      document.getElementById('materialLink').value = '';
      renderMaterials();
      showNotification('تمت إضافة المادة بنجاح', 'success');
    }

    function addQuiz() {
      const title = document.getElementById('quizTitle').value.trim();
      const description = document.getElementById('quizDescription').value.trim();
      const status = document.getElementById('quizStatus').value;
      if (!title || !description) {
        showNotification('يرجى ملء جميع الحقول', 'error');
        return;
      }
      const quizzes = JSON.parse(localStorage.getItem('quizzes_grade2art') || '[]');
      quizzes.push({ title, description, status });
      localStorage.setItem('quizzes_grade2art', JSON.stringify(quizzes));
      document.getElementById('quizTitle').value = '';
      document.getElementById('quizDescription').value = '';
      document.getElementById('quizStatus').value = 'متاح';
      renderQuizzes();
      showNotification('تمت إضافة الكويز بنجاح', 'success');
    }

    function removeHomework(index) {
      if (!confirm('هل أنت متأكد من حذف هذا الواجب؟')) return;
      const homeworkItems = JSON.parse(localStorage.getItem('homeworkItems_grade2art') || '[]');
      homeworkItems.splice(index, 1);
      localStorage.setItem('homeworkItems_grade2art', JSON.stringify(homeworkItems));
      renderHomework();
      showNotification('تم حذف الواجب بنجاح', 'success');
    }

    function removeMaterial(index) {
      if (!confirm('هل أنت متأكد من حذف هذه المادة؟')) return;
      const materials = JSON.parse(localStorage.getItem('materials_grade2art') || '[]');
      materials.splice(index, 1);
      localStorage.setItem('materials_grade2art', JSON.stringify(materials));
      renderMaterials();
      showNotification('تم حذف المادة بنجاح', 'success');
    }

    function removeQuiz(index) {
      if (!confirm('هل أنت متأكد من حذف هذا الكويز؟')) return;
      const quizzes = JSON.parse(localStorage.getItem('quizzes_grade2art') || '[]');
      quizzes.splice(index, 1);
      localStorage.setItem('quizzes_grade2art', JSON.stringify(quizzes));
      renderQuizzes();
      showNotification('تم حذف الكويز بنجاح', 'success');
    }

    function saveLink(lessonId) {
      const linkInput = document.getElementById(`link_${lessonId}`);
      const link = linkInput.value.trim();
      if (link && isValidYouTubeUrl(link)) {
        localStorage.setItem(`lesson_${lessonId}_link`, link);
        renderLessons();
        showNotification('تم حفظ الرابط بنجاح! ✅', 'success');
      } else if (link) {
        showNotification('يرجى إدخال رابط يوتيوب صحيح', 'error');
      } else {
        showNotification('يرجى إدخال رابط', 'error');
      }
    }

    function removeLink(lessonId) {
      if (confirm('هل أنت متأكد من حذف هذا الرابط؟')) {
        localStorage.removeItem(`lesson_${lessonId}_link`);
        renderLessons();
        showNotification('تم حذف الرابط بنجاح', 'success');
      }
    }

    function watchLesson(link) {
      if (link) {
        window.open(link, '_blank');
      }
    }

    function openLessonDetail(id) {
      window.location.href = `lesson.html?id=${encodeURIComponent(id)}`;
    }

    function downloadFile(link) {
      window.open(link, '_blank');
    }

    function isValidYouTubeUrl(url) {
      const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/(watch\?v=|embed\/)|youtu\.be\/).+/;
      return youtubeRegex.test(url);
    }

function downloadFile(link) {
      window.open(link, '_blank');
    }

function isValidYouTubeUrl(url) {
      const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/(watch\?v=|embed\/)|youtu\.be\/).+/;
      return youtubeRegex.test(url);
    }

    // Schedule Management Functions
    let editingScheduleId = null;

    function openAddScheduleModal() {
      editingScheduleId = null;
      document.getElementById('scheduleModalTitle').textContent = 'إضافة جدول دراسي';
      document.getElementById('scheduleForm').reset();
      document.getElementById('scheduleModal').classList.remove('hidden');
    }

    function closeScheduleModal() {
      document.getElementById('scheduleModal').classList.add('hidden');
      editingScheduleId = null;
    }

    async function saveSchedule(event) {
      event.preventDefault();
      
      const day = document.getElementById('scheduleDay').value;
      const subject = document.getElementById('scheduleSubject').value;
      const date = document.getElementById('scheduleDate').value;
      const timeFrom = document.getElementById('scheduleTimeFrom').value;
      const timeTo = document.getElementById('scheduleTimeTo').value;
      
      // Get current user data and teacher ID
      let teacherId = null;
      try {
        const userStr = localStorage.getItem('currentUser') || 
                       localStorage.getItem('user') || 
                       localStorage.getItem('userData');
        
        if (userStr) {
          const user = JSON.parse(userStr);
          teacherId = user.id || user.userId || user._id || user.teacherId;
          console.log('Teacher ID:', teacherId);
        }
      } catch (e) {
        console.warn('Failed to get teacher ID:', e);
      }

      const scheduleData = {
        day,
        subject,
        date,
        timeFrom,
        timeTo,
        grade: 'الصف الثاني الثانوي ادبي',
        instructor: teacherId // إضافة معرف المعلم
      };
      
      try {
        const token = localStorage.getItem('authToken') || '';
        const url = editingScheduleId 
          ? `https://courses-nine-eta.vercel.app/api/schedule/${editingScheduleId}`
          : 'https://courses-nine-eta.vercel.app/api/schedule';
        
        const method = editingScheduleId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(scheduleData)
        });
        
        if (response.ok) {
          showNotification(editingScheduleId ? 'تم تحديث الجدول بنجاح' : 'تم إضافة الجدول بنجاح', 'success');
          closeScheduleModal();
          loadSchedules();
        } else {
          const error = await response.json();
          showNotification(error.message || 'حدث خطأ أثناء حفظ الجدول', 'error');
        }
      } catch (error) {
        console.error('Schedule save error:', error);
        showNotification('حدث خطأ في الاتصال', 'error');
      }
    }

    async function editScheduleItem(scheduleId) {
      const schedule = schedules.find(s => (s.id || s._id) === scheduleId);
      if (!schedule) return;
      
      editingScheduleId = scheduleId;
      document.getElementById('scheduleModalTitle').textContent = 'تعديل الجدول الدراسي';
      
      document.getElementById('scheduleDay').value = schedule.day || '';
      document.getElementById('scheduleSubject').value = schedule.subject || '';
      document.getElementById('scheduleDate').value = schedule.date ? new Date(schedule.date).toISOString().split('T')[0] : '';
      document.getElementById('scheduleTimeFrom').value = schedule.timeFrom || '';
      document.getElementById('scheduleTimeTo').value = schedule.timeTo || '';
      
      document.getElementById('scheduleModal').classList.remove('hidden');
    }

    async function deleteScheduleItem(scheduleId) {
      if (!confirm('هل أنت متأكد من حذف هذا الجدول الدراسي؟')) return;
      
      try {
        const token = localStorage.getItem('authToken') || '';
        const response = await fetch(`https://courses-nine-eta.vercel.app/api/schedule/${scheduleId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          showNotification('تم حذف الجدول بنجاح', 'success');
          loadSchedules();
        } else {
          const error = await response.json();
          showNotification(error.message || 'حدث خطأ أثناء حذف الجدول', 'error');
        }
      } catch (error) {
        console.error('Schedule delete error:', error);
        showNotification('حدث خطأ في الاتصال', 'error');
      }
    }

    function showNotification(message, type = 'success') {
      // Remove any existing notifications
      const existingNotification = document.querySelector('.notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Create new notification
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      // Add to page
      document.body.appendChild(notification);
      
      // Show notification
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      // Hide and remove notification after 4 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 4000);
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-600 text-white' : 
        type === 'error' ? 'bg-red-600 text-white' : 
        'bg-blue-600 text-white'
      }`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Theme toggle
    const toggleBtn = document.getElementById("themeToggle");
    toggleBtn.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      toggleBtn.textContent = document.documentElement.classList.contains("dark") ? "☀️" : "🌙";
    });

    // User menu
    const userBtn = document.getElementById("userMenuBtn");
    const userMenu = document.getElementById("userMenu");
    userBtn.addEventListener("click", () => {
      userMenu.classList.toggle("hidden");
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("studentName");
      localStorage.removeItem("globalTeacherMode");
      window.location.href = "index_updated.html";
    });
    document.getElementById("logoutBtn2").addEventListener("click", () => {
      localStorage.removeItem("studentName");
      localStorage.removeItem("globalTeacherMode");
      window.location.href = "index_updated.html";
    });

    // Homework Management Functions
    async function editHomework(homeworkId) {
      const homeworkItem = homework.find(h => (h.id || h._id) === homeworkId);
      if (!homeworkItem) {
        showNotification('الواجب غير موجود', 'error');
        return;
      }
      
      // Fill the form with current data
      document.getElementById('homeworkSubject').value = homeworkItem.subject || homeworkItem.taskSubject || '';
      document.getElementById('homeworkDescription').value = homeworkItem.taskDescription || homeworkItem.description || '';
      document.getElementById('homeworkDueDate').value = homeworkItem.dueDate ? new Date(homeworkItem.dueDate).toISOString().split('T')[0] : '';
      
      // Store the ID for updating
      document.getElementById('homeworkSubject').dataset.editId = homeworkId;
      
      showNotification('تم تحميل بيانات الواجب للتعديل', 'success');
    }

    async function deleteHomework(homeworkId) {
      if (!confirm('هل أنت متأكد من حذف هذا الواجب؟')) return;
      
      try {
        const token = localStorage.getItem('authToken') || '';
        const resp = await fetch(`https://courses-nine-eta.vercel.app/api/tasks/${homeworkId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (resp.ok) {
          showNotification('تم حذف الواجب بنجاح', 'success');
          loadHomework(); // Reload homework list
        } else {
          throw new Error('فشل في حذف الواجب');
        }
      } catch (error) {
        console.error('Delete homework error:', error);
        showNotification('فشل في حذف الواجب', 'error');
      }
    }

    async function addHomework() {
      const subject = document.getElementById('homeworkSubject').value.trim();
      const description = document.getElementById('homeworkDescription').value.trim();
      const dueDate = document.getElementById('homeworkDueDate').value;
      
      if (!subject || !description || !dueDate) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
      }
      
      // Get current user data for teacher ID
      const getCurrentTeacherId = () => {
        const user = localStorage.getItem('user');
        const userData = localStorage.getItem('userData');
        const auth = localStorage.getItem('auth');
        const authToken = localStorage.getItem('authToken');
        
        // Try parsing different data sources
        try {
          if (user) {
            const parsed = JSON.parse(user);
            if (parsed.teacherId) return parsed.teacherId;
            if (parsed.id) return parsed.id;
          }
        } catch(e) {}
        
        try {
          if (userData) {
            const parsed = JSON.parse(userData);
            if (parsed.teacherId) return parsed.teacherId;
            if (parsed.id) return parsed.id;
          }
        } catch(e) {}
        
        try {
          if (auth) {
            const parsed = JSON.parse(auth);
            if (parsed.teacherId) return parsed.teacherId;
            if (parsed.id) return parsed.id;
          }
        } catch(e) {}
        
        return authToken || null;
      };
      
      const teacherId = getCurrentTeacherId();
      const editId = document.getElementById('homeworkSubject').dataset.editId;
      
      const homeworkData = {
        taskTitle: subject,
        taskDescription: description,
        subject: subject,
        dueDate: dueDate,
        grade: 'second-secondary-literature',
        ...(teacherId && { teacherId })
      };
      
      try {
        const token = localStorage.getItem('authToken') || '';
        const url = editId 
          ? `https://courses-nine-eta.vercel.app/api/tasks/${editId}`
          : 'https://courses-nine-eta.vercel.app/api/tasks/grade/second-secondary-literature';
        
        const resp = await fetch(url, {
          method: editId ? 'PUT' : 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(homeworkData)
        });
        
        if (resp.ok) {
          showNotification(editId ? 'تم تحديث الواجب بنجاح' : 'تم إضافة الواجب بنجاح', 'success');
          
          // Clear form
          document.getElementById('homeworkSubject').value = '';
          document.getElementById('homeworkDescription').value = '';
          document.getElementById('homeworkDueDate').value = '';
          delete document.getElementById('homeworkSubject').dataset.editId;
          
          loadHomework(); // Reload homework list
        } else {
          throw new Error(editId ? 'فشل في تحديث الواجب' : 'فشل في إضافة الواجب');
        }
      } catch (error) {
        console.error('Add/Edit homework error:', error);
        showNotification(editId ? 'فشل في تحديث الواجب' : 'فشل في إضافة الواجب', 'error');
      }
    }
  </script>
  
  <!-- Schedule Management Modal -->
  <div id="scheduleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 id="scheduleModalTitle" class="text-lg font-bold text-gray-800">إضافة جدول دراسي</h3>
        <button onclick="closeScheduleModal()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
      </div>
      
      <form id="scheduleForm" onsubmit="saveSchedule(event)">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">اليوم</label>
            <select id="scheduleDay" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
              <option value="">اختر اليوم</option>
              <option value="السبت">السبت</option>
              <option value="الأحد">الأحد</option>
              <option value="الاثنين">الاثنين</option>
              <option value="الثلاثاء">الثلاثاء</option>
              <option value="الأربعاء">الأربعاء</option>
              <option value="الخميس">الخميس</option>
              <option value="الجمعة">الجمعة</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">المادة</label>
            <input type="text" id="scheduleSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="اسم المادة" required>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">التاريخ</label>
            <input type="date" id="scheduleDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">من</label>
              <input type="time" id="scheduleTimeFrom" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">إلى</label>
              <input type="time" id="scheduleTimeTo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" required>
            </div>
          </div>
        </div>
        
        <div class="flex justify-end gap-3 mt-6">
          <button type="button" onclick="closeScheduleModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">إلغاء</button>
          <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">حفظ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Teacher Mode Auto System -->
  <script src="../js/teacher-mode.js"></script>
</body>
</html>