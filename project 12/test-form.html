<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار التسجيل</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            direction: rtl;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>اختبار نموذج التسجيل</h1>
    
    <form id="testForm">
        <div class="form-group">
            <label for="fullName">الاسم الرباعي:</label>
            <input type="text" id="fullName" name="fullName" required>
        </div>
        
        <div class="form-group">
            <label for="email">البريد الإلكتروني:</label>
            <input type="email" id="email" name="email" required>
        </div>
        
        <div class="form-group">
            <label for="password">كلمة المرور:</label>
            <input type="password" id="password" name="password" required>
        </div>
        
        <div class="form-group">
            <label for="location">المكان:</label>
            <select id="location" name="location" required>
                <option value="">اختر المكان</option>
                <option value="العسيرات">العسيرات</option>
                <option value="المنشاة">المنشاة</option>
                <option value="الاجايوه">الاجايوه</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="grade">الصف الدراسي:</label>
            <select id="grade" name="grade" required>
                <option value="">اختر الصف</option>
                <option value="الصف الأول الثانوي">الصف الأول الثانوي</option>
                <option value="الصف الثاني الثانوي">الصف الثاني الثانوي</option>
                <option value="الصف الثاني الثانوي علمي">الصف الثاني الثانوي علمي</option>
                <option value="الصف الثاني الثانوي ادبي">الصف الثاني الثانوي ادبي</option>
                <option value="الصف الثالث الثانوي">الصف الثالث الثانوي</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="phone">رقم الهاتف (اختياري):</label>
            <input type="tel" id="phone" name="phone">
        </div>
        
        <button type="submit">تسجيل الحساب</button>
    </form>
    
    <div id="result" class="result" style="display: none;"></div>
    
    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // Split full name into parts
        function splitFullName(fullName) {
            const names = fullName.trim().split(/\s+/);
            return {
                firstName: names[0] || '',
                secondName: names[1] || '',
                thirdName: names[2] || '',
                fourthName: names[3] || names[2] // If only 3 names, use third as fourth
            };
        }
        
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            // Log all form data
            console.log('=== Form Data ===');
            for (let pair of formData.entries()) {
                console.log(`${pair[0]}: ${pair[1]}`);
            }
            
            const fullName = formData.get('fullName');
            const nameParts = splitFullName(fullName);
            
            const userData = {
                firstName: nameParts.firstName,
                secondName: nameParts.secondName,
                thirdName: nameParts.thirdName,
                fourthName: nameParts.fourthName,
                email: formData.get('email'),
                password: formData.get('password'),
                location: formData.get('location'),
                grade: formData.get('grade'),
                role: 'student',
                phone: formData.get('phone') || undefined
            };
            
            console.log('=== User Data to Send ===');
            console.log(JSON.stringify(userData, null, 2));
            
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                console.log('Response Status:', response.status);
                
                const result = await response.json();
                console.log('Response Data:', result);
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <h3>نجح التسجيل! ✅</h3>
                        <p>الرسالة: ${result.message}</p>
                        <p>معرف المستخدم: ${result.user._id}</p>
                        <p>الاسم: ${result.user.name}</p>
                        <p>البريد: ${result.user.email}</p>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <h3>فشل التسجيل! ❌</h3>
                        <p>الرسالة: ${result.message}</p>
                        ${result.errors ? '<p>الأخطاء: ' + result.errors.map(e => e.msg).join(', ') + '</p>' : ''}
                    `;
                }
                
            } catch (error) {
                console.error('Error:', error);
                resultDiv.className = 'result error';
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    resultDiv.innerHTML = `
                        <h3>خطأ في الاتصال! 🚫</h3>
                        <p>لا يمكن الاتصال بالخادم</p>
                        <p>تأكد من تشغيل الباك إند على: ${API_BASE_URL}</p>
                        <p>الخطأ: ${error.message}</p>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <h3>خطأ غير متوقع! ⚠️</h3>
                        <p>${error.message}</p>
                    `;
                }
            }
        });
        
        console.log('Test form loaded and ready!');
    </script>
</body>
</html>